# 安装部署指南

本文档介绍如何安装和部署 SandboxFusion 代码沙盒系统。

---

## 环境要求

### 基础要求
- **操作系统**: Linux（推荐 Ubuntu 20.04/22.04）或 macOS
- **Python**: 3.11 或更高版本
- **包管理器**: Poetry

### 可选要求（完整功能）
- **Docker**: 用于容器化部署
- **Conda/Miniconda**: 用于管理 Python 运行时环境
- **特权模式**: 隔离执行功能需要 Linux 特权模式

---

## 方式一：本地开发环境

### 1. 克隆代码仓库

```bash
git clone https://github.com/bytedance/SandboxFusion.git
cd SandboxFusion
```

### 2. 创建 Python 环境

```bash
# 使用 conda 创建环境
conda create -n sandbox python=3.12
conda activate sandbox
```

### 3. 安装依赖

```bash
# 安装 Poetry（如果没有）
pip install poetry

# 安装项目依赖
poetry install
```

### 4. 安装语言运行时

根据需要安装特定语言的运行时环境：

#### Python 运行时

```bash
cd runtime/python
bash install-python-runtime.sh
```

这将创建名为 `sandbox-runtime` 的 conda 环境，包含 100+ 个常用 Python 库：
- 深度学习：TensorFlow、PyTorch
- Web 框架：Flask、Django
- 数据处理：NumPy、Pandas、SciPy、scikit-learn
- 可视化：Matplotlib、Seaborn、Plotly

#### Go 运行时

```bash
cd runtime/go
go mod download
```

#### Node.js 运行时

```bash
cd runtime/node
npm install
```

### 5. 启动服务

```bash
# 使用 Makefile
make run-online

# 或者直接运行
python -m sandbox.server.server
```

服务默认运行在 `http://localhost:8080`。

---

## 方式二：Docker 部署

Docker 是推荐的生产环境部署方式，已预装所有语言运行时。

### 1. 构建基础镜像

```bash
docker build -f ./scripts/Dockerfile.base -t code_sandbox:base .
```

基础镜像包含以下运行时：
- Python 3.11 + Poetry
- Go 1.23.3
- Node.js 20.11.0
- JDK 21
- .NET 8.0
- PHP 7.4.3
- Rust 1.76.0
- R, Lua, Ruby, Julia, Perl, Scala, Kotlin, Swift 等

### 2. 构建服务镜像

```bash
docker build -f ./scripts/Dockerfile.server -t code_sandbox:server .
```

### 3. 运行容器

```bash
docker run -d --rm --privileged -p 8080:8080 code_sandbox:server
```

**注意**：`--privileged` 参数是隔离执行功能所必需的。

### 4. 验证服务

```bash
curl http://localhost:8080/health
```

---

## 配置文件说明

SandboxFusion 使用 YAML 配置文件，默认读取 `sandbox/configs/local.yaml`。

### 配置文件位置

```bash
# 通过环境变量指定配置文件
export SANDBOX_CONFIG=local  # 读取 local.yaml
export SANDBOX_CONFIG=ci     # 读取 ci.yaml
```

### 配置结构

```yaml
# sandbox/configs/local.yaml 示例

sandbox:
  isolation: none          # 隔离模式: none 或 lite
  set_uid: null           # 执行用户 ID
  cleanup_process: true   # 是否清理进程
  restore_bash: true      # 是否恢复 bash
  max_concurrency: 10     # 最大并发数

dataset:
  database:
    backend: none         # 数据库后端: mysql 或 none
    cache: null           # 缓存配置
  registry: []            # 数据集注册表
  max_runner_concurrency: 5
  cpu_runner_url: null    # CPU 执行器 URL
  gpu_runner_url: null    # GPU 执行器 URL

common:
  logging_color: true     # 日志颜色输出
```

### 隔离模式说明

| 模式 | 说明 | 适用场景 |
|------|------|---------|
| `none` | 无隔离，仅使用资源限制 | 本地开发、可信代码 |
| `lite` | OverlayFS + cgroups + chroot | 生产环境、不可信代码 |

---

## 网络隔离配置（可选）

对于需要网络隔离的场景，可以创建独立的网络命名空间：

### 创建网络命名空间

```bash
# 语法: create_net_namespace.sh <namespace_name> <subnet> [--no-bridge]
sudo bash scripts/create_net_namespace.sh sandbox_ns 10.0.0.0/24
```

### 清理网络命名空间

```bash
sudo bash scripts/clean_net_namespace.sh sandbox_ns
```

---

## 常见问题

### 1. 权限不足

**问题**: 隔离模式运行时提示权限错误

**解决**: 确保使用 `--privileged` 运行 Docker，或在 Linux 上使用 root 权限

### 2. 运行时未找到

**问题**: 执行特定语言代码时提示运行时未安装

**解决**: 按照上述步骤安装对应语言的运行时环境

### 3. 端口冲突

**问题**: 8080 端口已被占用

**解决**: 修改启动命令指定其他端口

```bash
# Docker
docker run -d --rm --privileged -p 9090:8080 code_sandbox:server

# 本地
make run-online PORT=9090
```

---

## 下一步

安装完成后，请参阅以下文档：
- [02-Python-SDK使用指南.md](02-Python-SDK使用指南.md) - 学习如何使用 Python SDK
- [03-运行代码.md](03-运行代码.md) - 了解代码执行的详细用法
